<!DOCTYPE html>
<html lang="English">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenVPN Configuration with Easy-RSA | Nitrokey Documentation</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="User documentation of all Nitrokey products">
    <link rel="preload" href="/assets/css/17.styles.11dcf1c8.css" as="style"><link rel="preload" href="/assets/js/app.123296ed.js" as="script"><link rel="preload" href="/assets/js/39.1c9eb1ed.js" as="script"><link rel="preload" href="/assets/js/37.64470159.js" as="script"><link rel="prefetch" href="/assets/js/0.2fce8aff.js"><link rel="prefetch" href="/assets/js/1.f20138d3.js"><link rel="prefetch" href="/assets/js/10.c80f33ef.js"><link rel="prefetch" href="/assets/js/11.562bb1e8.js"><link rel="prefetch" href="/assets/js/12.7fc93c10.js"><link rel="prefetch" href="/assets/js/13.79457bb6.js"><link rel="prefetch" href="/assets/js/14.59392d6b.js"><link rel="prefetch" href="/assets/js/15.240ff16c.js"><link rel="prefetch" href="/assets/js/16.e341580c.js"><link rel="prefetch" href="/assets/js/18.110060cd.js"><link rel="prefetch" href="/assets/js/19.a0a6d9d8.js"><link rel="prefetch" href="/assets/js/2.8f08ee03.js"><link rel="prefetch" href="/assets/js/20.e013caf2.js"><link rel="prefetch" href="/assets/js/21.9dc6cb90.js"><link rel="prefetch" href="/assets/js/22.b2c5ec86.js"><link rel="prefetch" href="/assets/js/23.58238ef3.js"><link rel="prefetch" href="/assets/js/24.395a99d4.js"><link rel="prefetch" href="/assets/js/25.3876b484.js"><link rel="prefetch" href="/assets/js/26.a6584cdf.js"><link rel="prefetch" href="/assets/js/27.acafbfb5.js"><link rel="prefetch" href="/assets/js/28.f64e6d98.js"><link rel="prefetch" href="/assets/js/29.84da01e1.js"><link rel="prefetch" href="/assets/js/3.12b0183c.js"><link rel="prefetch" href="/assets/js/30.ed034bbe.js"><link rel="prefetch" href="/assets/js/31.ee8f7f24.js"><link rel="prefetch" href="/assets/js/32.2c7a4f88.js"><link rel="prefetch" href="/assets/js/33.d19c1666.js"><link rel="prefetch" href="/assets/js/34.97b5a72a.js"><link rel="prefetch" href="/assets/js/35.29520fff.js"><link rel="prefetch" href="/assets/js/36.9464f8cd.js"><link rel="prefetch" href="/assets/js/4.6ef60541.js"><link rel="prefetch" href="/assets/js/40.aa62edb4.js"><link rel="prefetch" href="/assets/js/41.3ffccf57.js"><link rel="prefetch" href="/assets/js/42.ce5c0857.js"><link rel="prefetch" href="/assets/js/43.0ded9a8a.js"><link rel="prefetch" href="/assets/js/44.6c7fd27b.js"><link rel="prefetch" href="/assets/js/45.05ad9cc5.js"><link rel="prefetch" href="/assets/js/46.180d3326.js"><link rel="prefetch" href="/assets/js/47.4fffbca1.js"><link rel="prefetch" href="/assets/js/48.1d285b09.js"><link rel="prefetch" href="/assets/js/49.1c0bd2b0.js"><link rel="prefetch" href="/assets/js/5.1ce31814.js"><link rel="prefetch" href="/assets/js/50.e1fe0063.js"><link rel="prefetch" href="/assets/js/51.9ba0a3ea.js"><link rel="prefetch" href="/assets/js/52.3754f446.js"><link rel="prefetch" href="/assets/js/53.0b5c7bad.js"><link rel="prefetch" href="/assets/js/54.8cf9b30f.js"><link rel="prefetch" href="/assets/js/55.aa9e54f0.js"><link rel="prefetch" href="/assets/js/56.f5432562.js"><link rel="prefetch" href="/assets/js/57.11da233c.js"><link rel="prefetch" href="/assets/js/58.c788193d.js"><link rel="prefetch" href="/assets/js/59.084669c8.js"><link rel="prefetch" href="/assets/js/6.954fc95c.js"><link rel="prefetch" href="/assets/js/60.808a960e.js"><link rel="prefetch" href="/assets/js/61.1c92a8d1.js"><link rel="prefetch" href="/assets/js/62.6a1188ec.js"><link rel="prefetch" href="/assets/js/63.064eca91.js"><link rel="prefetch" href="/assets/js/64.781fe146.js"><link rel="prefetch" href="/assets/js/65.afbbdf45.js"><link rel="prefetch" href="/assets/js/66.5fc7fc5e.js"><link rel="prefetch" href="/assets/js/67.71eaefcd.js"><link rel="prefetch" href="/assets/js/68.ca0c4d29.js"><link rel="prefetch" href="/assets/js/69.989b2c90.js"><link rel="prefetch" href="/assets/js/7.f4714c3b.js"><link rel="prefetch" href="/assets/js/70.c5bbac0c.js"><link rel="prefetch" href="/assets/js/71.1af5f707.js"><link rel="prefetch" href="/assets/js/72.56febce0.js"><link rel="prefetch" href="/assets/js/73.494f3a61.js"><link rel="prefetch" href="/assets/js/74.f371926d.js"><link rel="prefetch" href="/assets/js/75.51764d28.js"><link rel="prefetch" href="/assets/js/76.b5f9aaa4.js"><link rel="prefetch" href="/assets/js/77.75e6b404.js"><link rel="prefetch" href="/assets/js/78.e3e091e9.js"><link rel="prefetch" href="/assets/js/79.2bdaba80.js"><link rel="prefetch" href="/assets/js/8.5c752617.js"><link rel="prefetch" href="/assets/js/80.4ad08856.js"><link rel="prefetch" href="/assets/js/81.80d850f1.js"><link rel="prefetch" href="/assets/js/82.87ba4d0f.js"><link rel="prefetch" href="/assets/js/83.f8b43937.js"><link rel="prefetch" href="/assets/js/84.faa67df9.js"><link rel="prefetch" href="/assets/js/85.24698794.js"><link rel="prefetch" href="/assets/js/86.2844e49d.js"><link rel="prefetch" href="/assets/js/87.55150a83.js"><link rel="prefetch" href="/assets/js/9.5e13f527.js">
    <link rel="stylesheet" href="/assets/css/17.styles.11dcf1c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/nitrokey_logo_nur_schild_rot.svg" alt="Nitrokey Documentation" class="logo"> <span class="site-name can-hide">Nitrokey Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Product Menu" class="dropdown-title"><span class="title">Products</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fido2/" class="nav-link">
  Nitrokey FIDO2
</a></li><li class="dropdown-item"><!----> <a href="/u2f/" class="nav-link">
  Nitrokey FIDO U2F
</a></li><li class="dropdown-item"><!----> <a href="/hsm/" class="nav-link">
  Nitrokey HSM
</a></li><li class="dropdown-item"><!----> <a href="/pro/" class="nav-link router-link-active">
  Nitrokey Pro
</a></li><li class="dropdown-item"><!----> <a href="/start/" class="nav-link">
  Nitrokey Start
</a></li><li class="dropdown-item"><!----> <a href="/storage/" class="nav-link">
  Nitrokey Storage
</a></li><li class="dropdown-item"><!----> <a href="/x230/" class="nav-link">
  NitroPad X230
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pro/linux/openvpn-configuration-with-easyrsa.html" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/de/" class="nav-link">
  Deutsch
</a></li></ul></div></div> <a href="https://github.com/Nitrokey/nitrokey-documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Product Menu" class="dropdown-title"><span class="title">Products</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fido2/" class="nav-link">
  Nitrokey FIDO2
</a></li><li class="dropdown-item"><!----> <a href="/u2f/" class="nav-link">
  Nitrokey FIDO U2F
</a></li><li class="dropdown-item"><!----> <a href="/hsm/" class="nav-link">
  Nitrokey HSM
</a></li><li class="dropdown-item"><!----> <a href="/pro/" class="nav-link router-link-active">
  Nitrokey Pro
</a></li><li class="dropdown-item"><!----> <a href="/start/" class="nav-link">
  Nitrokey Start
</a></li><li class="dropdown-item"><!----> <a href="/storage/" class="nav-link">
  Nitrokey Storage
</a></li><li class="dropdown-item"><!----> <a href="/x230/" class="nav-link">
  NitroPad X230
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pro/linux/openvpn-configuration-with-easyrsa.html" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/de/" class="nav-link">
  Deutsch
</a></li></ul></div></div> <a href="https://github.com/Nitrokey/nitrokey-documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/pro/linux/" class="sidebar-link">Nitrokey Pro 2, Linux</a></li><li><a href="/pro/linux/change-user-and-admin-pin.html" class="sidebar-link">Change User and Admin PIN</a></li><li><a href="/pro/linux/smime-email-encryption.html" class="sidebar-link">S/MIME Email Encryption</a></li><li><a href="/pro/linux/openpgp-email-encryption.html" class="sidebar-link">OpenPGP Email Encryption</a></li><li><a href="/pro/linux/2fa-nextcloud.html" class="sidebar-link">Two-factor Authentication for Nextcloud accounts</a></li><li><a href="/pro/linux/openpgp-email-encryption-with-thunderbird.html" class="sidebar-link">OpenPGP Email Encryption With Thunderbird</a></li><li><a href="/pro/linux/openpgp-key-generation-on-device.html" class="sidebar-link">OpenPGP Key Generation On-Device</a></li><li><a href="/pro/linux/openpgp-key-generation-with-backup.html" class="sidebar-link">OpenPGP Key Generation With Backup</a></li><li><a href="/pro/linux/openpgp-key-generation-using-gpa.html" class="sidebar-link">OpenPGP Key Generation Using GPA</a></li><li><a href="/pro/linux/smime-email-encryption-with-thunderbird.html" class="sidebar-link">S/MIME Email Encryption with Thunderbird</a></li><li><a href="/pro/linux/login-with-eidauthenticate-on-stand-alone-windows-computers.html" class="sidebar-link">Login With EIDAuthenticate on Stand Alone Windows Computers</a></li><li><a href="/pro/linux/login-to-windows-domain-computers-with-ms-active-directory.html" class="sidebar-link">Login to Windows Domain Computers With MS Active Directory</a></li><li><a href="/pro/linux/two-factor-authentication-with-otp.html" class="sidebar-link">Two-factor Authentication with One-Time Passwords (OTP)</a></li><li><a href="/pro/linux/two-factor-authentication-for-google.html" class="sidebar-link">Two-factor Authentication for Google</a></li><li><a href="/pro/linux/elliptic-curves-ecc-support.html" class="sidebar-link">Elliptic Curves (ECC) Support</a></li><li><a href="/pro/linux/putty.html" class="sidebar-link">PuTTY</a></li><li><a href="/pro/linux/two-factor-authentication-for-erp-software-odoo.html" class="sidebar-link">Two-factor Authentication for ERP Software Odoo</a></li><li><a href="/pro/linux/openvpn-configuration-with-easyrsa.html" class="active sidebar-link">OpenVPN Configuration with Easy-RSA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pro/linux/openvpn-configuration-with-easyrsa.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/pro/linux/openvpn-configuration-with-easyrsa.html#server-side" class="sidebar-link">Server side</a></li><li class="sidebar-sub-header"><a href="/pro/linux/openvpn-configuration-with-easyrsa.html#client-side-configuration" class="sidebar-link">Client side configuration</a></li></ul></li><li><a href="/pro/linux/hard-disk-encryption.html" class="sidebar-link">Hard Disk Encryption</a></li><li><a href="/pro/linux/full-disk-encryption-with-cryptsetup-luks.html" class="sidebar-link">Full-Disk Encryption With cryptsetup/LUKS</a></li><li><a href="/pro/linux/automatic-screen-lock.html" class="sidebar-link">Automatic Screen Lock at Removal</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="openvpn-configuration-with-easy-rsa"><a href="#openvpn-configuration-with-easy-rsa" class="header-anchor">#</a> OpenVPN Configuration with Easy-RSA</h1> <p><strong>Notice:</strong> This guide is work-in-progress, and will be updated accordinlgy. Please take this status into consideration.</p> <p>This guide shows how to configure OpenVPN clients to login using a <a href="https://shop.nitrokey.com/shop/product/nk-pro-2-nitrokey-pro-2-3" target="_blank" rel="noopener noreferrer">Nitrokey Pro 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or a <a href="https://shop.nitrokey.com/de_DE/shop/product/nitrokey-storage-2-56" target="_blank" rel="noopener noreferrer">Nitrokey Storage 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. For software key management we will be using <a href="https://github.com/OpenVPN/easy-rsa" target="_blank" rel="noopener noreferrer">Easy-RSA<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, a utility that has been evolving alongside OpenVPN.</p> <p>To sign the certificates, we will use a <a href="https://shop.nitrokey.com/shop/product/nk-pro-2-nitrokey-pro-2-3" target="_blank" rel="noopener noreferrer">Nitrokey HSM 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> set up as <a href="https://docs.nitrokey.com/hsm/linux/creating-certificate-authority.html#creating-the-intermediate-certificate-authority" target="_blank" rel="noopener noreferrer">Certificate Authority<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, however this guide does not cover the set up of the CA itself (it is clear and <a href="https://docs.nitrokey.com/hsm/linux/creating-certificate-authority.html#sign-a-server-certificate" target="_blank" rel="noopener noreferrer">well documented here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p>We will use Easy-RSA, because it seems to provide some flexibility, and allows key management via external PKIs. We will use it on the server to issue the signing request, and repeat the same process on the client. The Certificate Signing Requests will be signed by the CA on the Nitorkey HSM, and re-transmitted to the server and the client.</p> <p>We can decompose the instructions of the guide as following:</p> <div class="language- extra-class"><pre><code>Server Side

	1. Install OpenVPN
	2. Install Easy-RSA
	3. Create a Public Key Infrastructure (PKI) for the OpenVPN server
	4. Create the server's Certificate Signing Request and the server's key
	5. Sign and retrieve the server's Certificate `
	6. Configure the OpenVPN Server 
	7. Start the OpenVPN Server

Client side 

	1. Install OpenVPN and Easy-RSA
	2. Create a Public Key Infrastructure (PKI) for the OpenVPN client
	3. Create the client's Certificate Signing Request and the client's Key
	4. Sign and issue the client's certificate
	5. Import the client certificate on the Nitrokey from the CA machine
	6. Retrieve the chain certificate from the CA machine 
	7. Configure the client to interact with the Nitrokey 
	8. Start the OpenVPN client
</code></pre></div><hr> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <p>In the following documentation we will require 3 different machines as following:</p> <ul><li>OpenVPN server (v. 2.5) on Debian 10 (EC2 virtual machine - AWS)</li> <li>OpenVPN client (v. 2.4.9) on Fedora 30 (local machine)</li> <li>The Certificate Authority will be accessible from a standalone machine with Fedora 30 (local machine)</li></ul> <p>To interact with the devices we will require <a href="https://github.com/OpenSC/OpenSC/wiki" target="_blank" rel="noopener noreferrer">OpenSC 0.20<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> installed on the client and CA machine (the local machines). You can follow the instructions to set it up in <a href="https://github.com/OpenSC/OpenSC/wiki/Compiling-and-Installing-on-Unix-flavors" target="_blank" rel="noopener noreferrer">this link (*Unix)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>To download the dependencies on Fedora machines we can this instruction:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">su</span> -c <span class="token string">'dnf install readline-devel openssl-devel libxslt docbook-style-xsl pcsc-lite-devel automake autoconf libtool gcc zlib-devel'</span>
</code></pre></div><p>For Debian Linux, more recent OpenSC packages are available <a href="https://github.com/Nitrokey/opensc-build" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>We will use the following Nitrokeys for physical key management:</p> <ul><li><p>An authentication key using the <a href="https://www.nitrokey.com/files/doc/Nitrokey_Pro_factsheet.pdf" target="_blank" rel="noopener noreferrer">Nitrokey Pro 2 (pdf)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>A Certificate Authority (CA) using the <a href="https://www.nitrokey.com/files/doc/Nitrokey_HSM_factsheet.pdf" target="_blank" rel="noopener noreferrer">Nitrokey HSM 2 (pdf)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <p>As a reminder, to build a Certificate Authority on Nitrokey HSM 2, you may follow the instructions available <a href="/hsm/linux/creating-certificate-authority.html#sign-a-server-certificate">in the documentation</a>.</p> <p>Alternatively you may set up your own CA on a <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-a-certificate-authority-ca-on-ubuntu-20-04" target="_blank" rel="noopener noreferrer">on a separate machine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or use the OpenVPN tutorial which also relies on <a href="https://openvpn.net/community-resources/setting-up-your-own-certificate-authority-ca/" target="_blank" rel="noopener noreferrer">Easy-RSA<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The last 2 options rely on software solutions for key management.</p> <hr> <h2 id="server-side"><a href="#server-side" class="header-anchor">#</a> Server side</h2> <h4 id="_1-install-openvpn"><a href="#_1-install-openvpn" class="header-anchor">#</a> 1. Install OpenVPN</h4> <ol><li><h5 id="first-we-need-to-enable-ip-forwarding-by-editing-etc-sysctl-conf-file"><a href="#first-we-need-to-enable-ip-forwarding-by-editing-etc-sysctl-conf-file" class="header-anchor">#</a> First we need to enable IP Forwarding by editing <code>/etc/sysctl.conf</code> file</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ editor /etc/sysctl.conf
</code></pre></div><ol start="2"><li><h5 id="uncomment-or-edit-accordingly-the-following-line"><a href="#uncomment-or-edit-accordingly-the-following-line" class="header-anchor">#</a> Uncomment or edit accordingly the following line</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span>
</code></pre></div><ol start="3"><li><h5 id="close-after-saving-it-and-enter-this-command"><a href="#close-after-saving-it-and-enter-this-command" class="header-anchor">#</a> Close after saving it, and enter this command</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ sysctl -p
</code></pre></div><p>Once IP forwarding is done, we will need to download the latest release of OpenvPN for our Debian 10 server, according to <a href="https://community.openvpn.net/openvpn/wiki/OpenvpnSoftwareRepos?__cf_chl_jschl_tk__=62f18d28588ed33f3c599052099bf7e46feb1378-1599355462-0-AXDsohY5kUawZr5f8zhAXWpKu5VPhIRdq9_e91od4P57mQ1ark9iUC72WozqlGT7OJpJBp5Dn9nxKCPxW7eOU6gqq8s7GY02YXtfSWjsfVRsilbZszJwK-_HtzZrDMx6g1REseNP9NUwj402W70xcVAiQrRJBuYqOal9Q3JIEywbW_XRrEIWEMsklfKgq5Dq6N_UAb14YgR__-G0VoNiH6cGvhzZgZ_puEjIy2yF4gm0RUrO7exX5SX3jUwf3xT9htaH1DHoYqe8cxOngl7NyY8JG4zjhhxCe4beGOi0FHlimW2TqtGoeN85-aoGMSp9gA" target="_blank" rel="noopener noreferrer">these instructions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <ol start="4"><li><h5 id="change-to-root-and-download-the-gpg-key-that-signed-the-package"><a href="#change-to-root-and-download-the-gpg-key-that-signed-the-package" class="header-anchor">#</a> Change to root and download the GPG key that signed the package</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> -s 
<span class="token comment"># wget -O - https://swupdate.openvpn.net/repos/repo-public.gpg|apt-key add -</span>
</code></pre></div><ol start="5"><li><h5 id="add-the-url-of-the-adequate-openvpn-packages-to-the-sources-list-file"><a href="#add-the-url-of-the-adequate-openvpn-packages-to-the-sources-list-file" class="header-anchor">#</a> Add the URL of the adequate OpenVPN packages to the <code>sources.list</code> file</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># echo &quot;deb http://build.openvpn.net/debian/openvpn/release/2.5 buster main&quot; &gt; /etc/apt/sources.list.d/openvpn-aptrepo.list</span>
<span class="token comment"># exit</span>
</code></pre></div><p>We downloaded OpenVPN 2.5 as &quot;password prompt&quot; requires at least OpenVPN <a href="https://community.openvpn.net/openvpn/ticket/1215?__cf_chl_jschl_tk__=92b2a9776b54ce71b2f15e4d3f62dbdb5ee68f5f-1599568561-0-AY906nmSrFwe8EfT2PKawtrgl2NF72nwMrG9mp57SgIAqFmzxHiqod7ED0oVbimJlDD2xzLNLbQU6iUlVImbo8Q25qpDJVJ56YHbE4JKQSusHiwS8GLMm8Di9Gk6k63_qN5SDot-ABpgFoNcaRUHGZQ0fVYKYXZDf5E_0ZAOjPWsD2FXLfc7atx53t9scbdGF1p7xl2VRFcBoy2l7KgvvZU589YNs1wsRG62neISVpM-9E-s9CuccSAX8y3ZQfZUq7et9QIdgaSK9g-PhFqKWJhZLFkmTwR0wmYbKXjhxQ6j" target="_blank" rel="noopener noreferrer">version 2.4.8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to login.</p> <ol start="6"><li><h5 id="next-we-download-openvpn"><a href="#next-we-download-openvpn" class="header-anchor">#</a> Next we download OpenVPN</h5></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openvpn
</code></pre></div><p>If you want to check the version, it possible by calling <code>--version</code> and print the following:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> openvpn --version
OpenVPN <span class="token number">2</span>.5_beta3 x86_64-pc-linux-gnu <span class="token punctuation">[</span>SSL <span class="token punctuation">(</span>OpenSSL<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>LZO<span class="token punctuation">]</span> <span class="token punctuation">[</span>LZ4<span class="token punctuation">]</span> <span class="token punctuation">[</span>EPOLL<span class="token punctuation">]</span> <span class="token punctuation">[</span>PKCS11<span class="token punctuation">]</span> <span class="token punctuation">[</span>MH/PKTINFO<span class="token punctuation">]</span> <span class="token punctuation">[</span>AEAD<span class="token punctuation">]</span> built on Sep  <span class="token number">1</span> <span class="token number">2020</span>
library versions: OpenSSL <span class="token number">1.1</span>.1d <span class="token number">10</span> Sep <span class="token number">2019</span>, LZO <span class="token number">2.10</span>
Originally developed by James Yonan
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2002</span>-2018 OpenVPN Inc <span class="token operator">&lt;</span>sales@openvpn.net<span class="token operator">&gt;</span>
Compile <span class="token function">time</span> defines: <span class="token assign-left variable">enable_async_push</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_comp_stub</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_crypto_ofb_cfb</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_debug</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_def_auth</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_dependency_tracking</span><span class="token operator">=</span>no <span class="token punctuation">\</span> <span class="token assign-left variable">enable_dlopen</span><span class="token operator">=</span>unknown <span class="token assign-left variable">enable_dlopen_self</span><span class="token operator">=</span>unknown <span class="token assign-left variable">enable_dlopen_self_static</span><span class="token operator">=</span>unknown <span class="token assign-left variable">enable_fast_install</span><span class="token operator">=</span>needless <span class="token assign-left variable">enable_fragment</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_iproute2</span><span class="token operator">=</span>yes <span class="token punctuation">\</span> <span class="token assign-left variable">enable_libtool_lock</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_lz4</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_lzo</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_maintainer_mode</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_management</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_multihome</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_pam_dlopen</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_pedantic</span><span class="token operator">=</span>no <span class="token punctuation">\</span> <span class="token assign-left variable">enable_pf</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_pkcs11</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_plugin_auth_pam</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_plugin_down_root</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_plugins</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_port_share</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_selinux</span><span class="token operator">=</span>no <span class="token punctuation">\</span> <span class="token assign-left variable">enable_shared</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_shared_with_static_runtimes</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_silent_rules</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_small</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_static</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_strict</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_strict_options</span><span class="token operator">=</span>no <span class="token punctuation">\</span> <span class="token assign-left variable">enable_systemd</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_werror</span><span class="token operator">=</span>no <span class="token assign-left variable">enable_win32_dll</span><span class="token operator">=</span>yes <span class="token assign-left variable">enable_x509_alt_username</span><span class="token operator">=</span>yes <span class="token assign-left variable">with_aix_soname</span><span class="token operator">=</span>aix <span class="token assign-left variable">with_crypto_library</span><span class="token operator">=</span>openssl <span class="token assign-left variable">with_gnu_ld</span><span class="token operator">=</span>yes <span class="token punctuation">\</span> <span class="token assign-left variable">with_mem_check</span><span class="token operator">=</span>no <span class="token assign-left variable">with_sysroot</span><span class="token operator">=</span>no
</code></pre></div><h4 id="_2-install-easy-rsa"><a href="#_2-install-easy-rsa" class="header-anchor">#</a> 2. Install Easy-RSA</h4> <p>To build the PKI, we will download the latest version of Easy-RSA on the server and client machines. To get the latest release, go to the <a href="https://github.com/OpenVPN/easy-rsa/releases" target="_blank" rel="noopener noreferrer">Releases page on the official EasyRSA GitHub project<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, copy the download link for the file ending in <code>.tgz</code>, and then paste it into the following command:</p> <h5 id="_1-download-the-latest-release"><a href="#_1-download-the-latest-release" class="header-anchor">#</a> 1. Download the latest release</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> ~
<span class="token function">wget</span> -P ~/ https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.7/EasyRSA-3.0.7.tgz
</code></pre></div><h5 id="_2-extract-the-tarball"><a href="#_2-extract-the-tarball" class="header-anchor">#</a> 2. Extract the tarball</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> ~
$ <span class="token function">tar</span> xvf EasyRSA-3.0.7.tgz
$ <span class="token function">mv</span> EasyRSA-3.0.7/ easyrsa/ <span class="token comment"># rename folder</span>
</code></pre></div><h4 id="_3-create-a-pki-for-openvpn-server"><a href="#_3-create-a-pki-for-openvpn-server" class="header-anchor">#</a> 3. Create a PKI for OpenVPN server</h4> <p>Before you can create your OpenVPN server’s private key and certificate, you need to create a local Public Key Infrastructure directory on your OpenVPN server. You will use this directory to manage the server and clients’ certificate requests, instead of making them directly on your CA server.</p> <p>To build a PKI directory on your OpenVPN server, you’ll need to populate a file called <code>vars</code> with some default values.</p> <h5 id="_1-create-a-vars-file"><a href="#_1-create-a-vars-file" class="header-anchor">#</a> 1. Create a <code>vars</code> file</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">touch</span> ~/easyrsa/vars
$ <span class="token builtin class-name">cd</span> easyrsa/
$ editor vars
</code></pre></div><h5 id="_2-once-the-file-is-opened-paste-in-the-following-two-lines"><a href="#_2-once-the-file-is-opened-paste-in-the-following-two-lines" class="header-anchor">#</a> 2. Once the file is opened, paste in the following two lines</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>set_var EASYRSA_ALGO <span class="token string">&quot;ec&quot;</span>
set_var EASYRSA_DIGEST <span class="token string">&quot;sha512&quot;</span>
</code></pre></div><p>These are the only two lines that you need in this <code>vars</code> file on your OpenVPN server since it will not be used as a Certificate Authority. They will ensure that your private keys and certificate requests are configured to use Elliptic Curve Cryptography (ECC) to generate keys, and secure signatures for your clients and OpenVPN server.</p> <p>In regards to the choice of the cryptographic algorithms, I follow the model in <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-an-openvpn-server-on-centos-8" target="_blank" rel="noopener noreferrer">this tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and you can customize these according to your specific needs.</p> <h5 id="_3-initialize-the-pki"><a href="#_3-initialize-the-pki" class="header-anchor">#</a> 3. Initialize the PKI</h5> <p>Once you have populated the <code>vars</code> file you can proceed with creating the PKI directory. To do so, run the easyrsa script with the init-pki option:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./easyrsa init-pki
</code></pre></div><p>After you’ve initialized your PKI on the OpenVPN server, you are ready to move on to the next step, which is creating an OpenVPN server certificate request and private key.</p> <h4 id="_4-create-server-req-and-server-key"><a href="#_4-create-server-req-and-server-key" class="header-anchor">#</a> 4. Create <code>server.req</code> and <code>server.key</code></h4> <p>Now that your OpenVPN server has all the prerequisites installed, the next step is to generate a key pair composed of a private key (to keep secret), and a Certificate Signing Request (<code>.csr</code>) on your OpenVPN server.</p> <p>In general terms, on systems where we generate a key and request, these files are left unencrypted by using the <code>nopass</code> argument, since servers usually need to start up without any password input. This generates an <em>unencrypted key</em>, so mind <em>protect its access and file permissions</em> carefully.</p> <div class="custom-block tip"><p class="custom-block-title">Configuration notes from OpenVPN:</p> <ol><li>The server, and each client, must have their own cert and key file. The server and all clients will use the same CA file.</li> <li>Server certificate should have the following:</li></ol> <ul><li><code>keyUsage: digitalSignature, keyEncipherment</code></li> <li><code>extendedKeyUsage: serverAuth</code></li></ul></div> <h5 id="_1-create-the-signing-request-for-the-server"><a href="#_1-create-the-signing-request-for-the-server" class="header-anchor">#</a> 1. Create the signing request for the server</h5> <p>Navigate to the <code>~/easyrsa</code> directory on your OpenVPN Server as your non-root user, and enter the following commands:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> easyrsa/
$ ./easyrsa gen-req server nopass
</code></pre></div><p>This will create a private key for the server and a certificate request file called <code>server.req</code>.</p> <p>Once you have a signed certificate, you’ll transfer it back to the OpenVPN server.</p> <h5 id="_2-copy-the-key-to-the-openvpn-server-directory"><a href="#_2-copy-the-key-to-the-openvpn-server-directory" class="header-anchor">#</a> 2. Copy the key to the OpenVPN server directory</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">cp</span> /home/admin/EasyRSA/pki/private/server.key /etc/openvpn/server/
</code></pre></div><p>After completing these steps, you have successfully created a private key for your OpenVPN server. You have also generated a Certificate Signing Request for the OpenVPN server.</p> <div class="custom-block tip"><p class="custom-block-title">File extensions for certificate signing requests</p> <p>The file extension that is adopted by the CA and HSM tutorial indicates the creation of a <code>.csr</code> file, however Easy-RSA creates certificate signing requests with a <code>.req</code> extension.</p> <p>We will use interchangeably both extensions, while making sure that we transfer the right files to the Certificate Authority, and generate a final certificate with a <code>.crt</code> extension.</p></div> <p>In the next section of this guide, we will sign a <code>.req</code> file with our CA on deployed on the HSM 2 device. For this purpose, I will use a dedicated machine to sign the requests.</p> <h4 id="_5-sign-and-retrieve-server-crt"><a href="#_5-sign-and-retrieve-server-crt" class="header-anchor">#</a> 5. Sign and retrieve <code>server.crt</code></h4> <p>The following instructions require the transfer of the <code>server.req</code> (or <code>server.csr</code>) file to the CA system.</p> <p>The transfer itself is not security sensitive, though it is wise to verify if the received file matches the sender's copy, if the transport is untrusted.</p> <p>In order to go through these steps, I will extensively rely on <a href="/hsm/linux/creating-certificate-authority.html#creating-the-intermediate-certificate-authority">these instructions</a>, to sign the certificate signing requests, once we generated them with Easy-RSA.</p> <h5 id="_1-sign-the-server-req-file"><a href="#_1-sign-the-server-req-file" class="header-anchor">#</a> 1. Sign the <code>server.req</code> file</h5> <p>On the local machine dedicated to access the HSM, we will use the tools provided by Opensc 0.20 in order to sign the <code>.req</code> file, and send it back to the OpenVPN server. We assume we have transferred the file from the server machine to the CA machine.</p> <p>First we start by plugging the HSM Nitrokey, and enter this instruction for listing the keys available.</p> <ol><li>Query the list of available devices</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ p11tool --list-all
</code></pre></div><p>​	<strong>(Required step)</strong> If this is the first time you sign a certificate with the CA, you might want to retrieve the URI of the CA's private key from the HSM, and include it in the config file.</p> <ul><li>The key's URI should be in this format:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>pkcs11:model<span class="token operator">=</span>PKCS%2315%20emulated<span class="token punctuation">;</span><span class="token assign-left variable">manufacturer</span><span class="token operator">=</span>www.CardContact.de<span class="token punctuation">;</span><span class="token assign-left variable">serial</span><span class="token operator">=</span>DENK0104068<span class="token punctuation">;</span><span class="token assign-left variable">token</span><span class="token operator">=</span>SmartCard-HSM%20%28UserPIN%29%00%00%00%00%00%00%00%00%00<span class="token punctuation">;</span><span class="token assign-left variable">id</span><span class="token operator">=</span>%E0%16%1C%C8%B6%F5%D6%6A%C6%83%5E%CD%EC%B6%23%FC%05%06%A6%75<span class="token punctuation">;</span><span class="token assign-left variable">object</span><span class="token operator">=</span>root<span class="token punctuation">;</span><span class="token assign-left variable">type</span><span class="token operator">=</span>private
</code></pre></div><ol start="2"><li>Create <code>openvpn/</code> directory under <code>certificate-authority/</code></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ mkdir/opt/certificate-authority/
$ <span class="token builtin class-name">cd</span> /opt/certificate-authority/
</code></pre></div><ol start="3"><li>Sign the <code>server.req</code></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ openssl ca -config sign_server_csrs.ini -engine pkcs11 -keyform engine -days <span class="token number">375</span> -notext -md sha512 -create_serial -in server.req -out /home/user/pki/issued/server.crt 
</code></pre></div><h5 id="_2-retrieve-the-server-crt-file-to-the-server-machine"><a href="#_2-retrieve-the-server-crt-file-to-the-server-machine" class="header-anchor">#</a> 2. Retrieve the <code>server.crt</code> file to the server machine</h5> <ol><li>Transfer the signed certificates to the server</li></ol> <p>From the CA machine, copy the files <code>server.crt</code> and <code>chain.crt</code> to the OpenVPN server. In this example we will use the <code>scp</code> command as following:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">scp</span> openvpn/<span class="token punctuation">{</span>server.crt,chain.crt<span class="token punctuation">}</span> admin@your_openvpnserver_ip:/tmp
</code></pre></div><ol start="2"><li>Place the certificates on the server's directory</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">mv</span> /tmp/<span class="token punctuation">{</span>server.crt,chain.crt<span class="token punctuation">}</span> /etc/openvpn/server
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">CA Certificate and `chain.crt`</p> <p>In the above, the CA returns the signed sever certificate, and includes the CA certificate <code>CA.crt</code> which is the <code>chain.crt</code> file. This can be done over an insecure channel, though the client is encouraged to confirm if the received <code>chain.crt</code> is valid, if the transport is untrusted.</p> <p>It is possible to rename the file <code>chain.crt</code> file to <code>CA.crt</code> on the target machine, however we will use <code>chain.crt</code> in the next instructions.</p></div> <h4 id="_6-configure-the-openvpn-server"><a href="#_6-configure-the-openvpn-server" class="header-anchor">#</a> 6. Configure the OpenVPN server</h4> <p>A connection that uses TLS requires multiple <a href="https://wiki.teltonika-networks.com/view/OpenVPN_configuration_examples" target="_blank" rel="noopener noreferrer">certificates and keys for authentication<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Now that we issued and signed those, we can place them in the right directories. The breakdown of the certificates and keys that must be located at the root directory are the following:</p> <div class="language- extra-class"><pre><code>OpenVPN server 

	- The root certificate file (CA.crt or chain.crt in our setup)
	- Server certificate
	- Server key
	- Diffie Hellman Parameters (optional)
</code></pre></div><p>On your OpenVPN server, now you can create the configuration file <code>server.conf</code> with your favorite text editor. The file can be configured according to your needs, while we make sure to change the server certificate and key sections according the names you chose for the your the files we signed:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># OpenVPN Server Certificate - CA, server key and certificate</span>
ca chain.crt
cert server.crt
key server.key
</code></pre></div><p>Here is the configuration file we can use for testing these instructions:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>port <span class="token number">1194</span>
proto udp
dev tun
ca ca.crt
cert server.crt
key server.key  <span class="token comment"># This file should be kept secret</span>
dh dh.pem
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0
push <span class="token string">&quot;redirect-gateway def1 bypass-dhcp&quot;</span>
push <span class="token string">&quot;dhcp-option DNS 208.67.222.222&quot;</span>
push <span class="token string">&quot;dhcp-option DNS 208.67.220.220&quot;</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>
tls-auth ta.key <span class="token number">0</span> <span class="token comment"># This file is secret</span>
cipher AES-256-CBC
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn/openvpn-status.log
log         /var/log/openvpn/openvpn.log
log-append  /var/log/openvpn/openvpn.log
verb <span class="token number">3</span>
explicit-exit-notify <span class="token number">1</span>
tls-version-min <span class="token number">1.2</span> <span class="token comment"># Lower boundary for TLS version </span>
tls-version-max <span class="token number">1.2</span> <span class="token comment"># Higher boundary for TLS version</span>
</code></pre></div><p>To test if the configuration functions properly, we can use this command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> openvpn --server --config server.conf
</code></pre></div><h4 id="_7-start-the-openvpn-service-on-the-server"><a href="#_7-start-the-openvpn-service-on-the-server" class="header-anchor">#</a> 7. Start the OpenVPN service on the server</h4> <p>Enable the OpenVPN service by adding it to systemctl, and start it using these commands:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl -f <span class="token builtin class-name">enable</span> openvpn@server
$ <span class="token function">sudo</span> systemctl start openvpn@server
</code></pre></div><p>To Double check if the OpenVPN service is active use this command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl status openvpn@server
</code></pre></div><p>The OpenVPN should be running at this point.</p> <hr> <h2 id="client-side-configuration"><a href="#client-side-configuration" class="header-anchor">#</a> Client side configuration</h2> <div class="language- extra-class"><pre><code>	1. Install OpenVPN and Easy-RSA
	2. Create a Public Key Infrastructure (PKI) for the OpenVPN client
	3. Create the client's certificate signing request and the client's key
	4. Sign and issue the client's certificate
	5. Import the client certificate on the Nitrokey from the CA machine
	6. Retrieve the chain certificate from the CA machine 
	7. Configure the client to interact with the Nitrokey 
	8. Start the OpenVPN client
</code></pre></div><h4 id="_1-install-openvpn-and-easy-rsa"><a href="#_1-install-openvpn-and-easy-rsa" class="header-anchor">#</a> 1. Install OpenVPN and Easy-RSA</h4> <h5 id="_1-install-the-software"><a href="#_1-install-the-software" class="header-anchor">#</a> 1. Install the software</h5> <p>We can use directly <code>dnf install</code> to install OpenVPN 2.4.9 and Easy-RSA 3.0.7</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> dnf <span class="token function">install</span> openvpn easy-rsa
</code></pre></div><h5 id="_2-then-we-create-as-non-root-a-directory-for-easy-rsa-called-easy-rsa"><a href="#_2-then-we-create-as-non-root-a-directory-for-easy-rsa-called-easy-rsa" class="header-anchor">#</a> 2. Then we create as non-root a directory for Easy RSA called <code>Easy-RSA</code></h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">mkdir</span> ~/easyrsa
</code></pre></div><h5 id="_3-and-link-it-to-the-easy-rsa-package-we-just-installed"><a href="#_3-and-link-it-to-the-easy-rsa-package-we-just-installed" class="header-anchor">#</a> 3. And link it to the Easy RSA package we just installed</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ln</span> -s /usr/share/easy-rsa/3/* ~/easyrsa/
</code></pre></div><h5 id="_2-create-a-pki-for-the-openvpn-client"><a href="#_2-create-a-pki-for-the-openvpn-client" class="header-anchor">#</a> 2. Create a PKI for the OpenVPN client</h5> <p>In the same manner we created a PKI on the OpenVPN server, we will create a PKI using Easy-RSA on the client side.</p> <h5 id="_3-create-a-client-req-and-client-key"><a href="#_3-create-a-client-req-and-client-key" class="header-anchor">#</a> 3. Create a <code>client.req</code> and <code>client.key</code></h5> <p>In the same manner we issued the key pair on the sever, we generate a key pair for the client which will be composed of the <code>client.req</code> file and the <code>client.key</code> file. The latter must be kept secret on the client machine.</p> <h5 id="_4-sign-client-req-and-issue-the-client-crt-file"><a href="#_4-sign-client-req-and-issue-the-client-crt-file" class="header-anchor">#</a> 4. Sign <code>client.req</code> and issue the <code>client.crt</code> file</h5> <p>To transfer the <code>client.req</code> file to the CA machine, we will use the same method as we did for the <code>server.req</code> file.</p> <p>Once transferred, on the CA machine we sign the certificate signing request file with this command</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ openssl ca -config sign_server_csrs.ini -engine pkcs11 -keyform engine -days <span class="token number">375</span> -notext -md sha512 -create_serial -in client.req -out /home/user/pki/issued/client.crt 
</code></pre></div><h4 id="_5-import-client-crt-on-the-nitrokey-from-the-ca-machine"><a href="#_5-import-client-crt-on-the-nitrokey-from-the-ca-machine" class="header-anchor">#</a> 5. Import <code>client.crt</code> on the Nitrokey from the CA machine</h4> <p>/// Some documentation says that we can use the ./pkitool script available with Easy-RSA, to directly initialize a key pair on the Nitrokey, however the pkitool utility seems to be deprecated ///</p> <p>After creating the <code>client.crt</code> file, we plug the Nitrokey Pro 2 device in the CA machine, and import the <code>.crt</code> to the Pro 2 device using this command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ pkcs15-init --store-certificate client.crt --id <span class="token number">3</span>
</code></pre></div><p>You can see if the key is effectively stored on the Nitrokey using this command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ pkcs15-tool -c

</code></pre></div><p>Or alternatively</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ pkcs11-tool --list-objects 
</code></pre></div><p>Fore more commands you can refer to the <a href="https://github.com/OpenSC/OpenSC/wiki/OpenPGP-card" target="_blank" rel="noopener noreferrer">OpenSC wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h4 id="_6-retrieve-the-chain-crt-file-from-the-ca-machine"><a href="#_6-retrieve-the-chain-crt-file-from-the-ca-machine" class="header-anchor">#</a> 6. Retrieve the <code>chain.crt</code> file from the CA machine</h4> <p>While we keep the <code>client.crt</code>stored on the nitrokey Pro 2 device, we must retrieve the <code>chain.crt</code> file on the client machine, and store it in the adequate directory. We may use <code>scp</code> as in the method explained in the server section of this guide.</p> <h4 id="_7-configure-the-client-to-interact-with-the-nitrokey"><a href="#_7-configure-the-client-to-interact-with-the-nitrokey" class="header-anchor">#</a> 7. Configure the client to interact with the Nitrokey</h4> <p>Now back on the client machine, we will plug the Nitrokey Pro and use it to establish the VPN connection with the server.  In general terms, a connection that uses TLS requires multiple certificates and keys for authentication:</p> <div class="language- extra-class"><pre><code>OpenVPN client 
	- The root certificate file (`chain.crt`)
	- Client certificate
	- Client key
</code></pre></div><p>For this guide we can the following <code>client.conf</code> file, and add the required options to it accordingly:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>client
dev tun
proto udp
remote <span class="token operator">&lt;</span>server<span class="token operator">&gt;</span> <span class="token number">1194</span>
resolv-retry infinite
nobind
user nobody
group nobody
persist-key
persist-tun
ca ca.crt
remote-cert-tls server
cipher AES-256-CBC
verb <span class="token number">3</span>
redirect-gateway def1
tls-version-min <span class="token number">1.2</span> <span class="token comment"># Lower boundary for TLS version </span>
tls-version-max <span class="token number">1.2</span> <span class="token comment"># Higher boundary for TLS version</span>
</code></pre></div><h5 id="_1-determine-the-correct-object"><a href="#_1-determine-the-correct-object" class="header-anchor">#</a> 1. Determine the correct object</h5> <p>Each PKCS#11 provider can support multiple devices. In order to view the available object list you can use the following command:</p> <div class="language- extra-class"><pre class="language-text"><code>$ openvpn --show-pkcs11-ids /usr/lib64/pkcs11/opensc-pkcs11.so 

The following objects are available for use.
Each object shown below may be used as parameter to
--pkcs11-id option please remember to use single quote mark.

Certificate
       DN:             CN=client
       Serial:         E53DA75C5B8F1518F520BCEF0128C09F
       Serialized id:  pkcs11:model=pkcs11:model=PKCS%NNNN%20emulated;token=User%20PIN%20%28OpenPGP%20card%29;manufacturer=ZeitControl;serial=000NNNNNN;id=%03

</code></pre></div><p>Each certificate/private key pair have unique <code>Serialized id</code> string. The serialized id string of the requested certificate should be specified, in the configuration file. We can do this by adding the <code>pkcs11-id</code> option using single quote marks.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pkcs11-id <span class="token string">'pkcs11:model=pkcs11:model=PKCS%NNNN%20emulated;token=User%20PIN%20%28OpenPGP%20card%29;manufacturer=ZeitControl;serial=000NNNNNN;id=%03'</span>
</code></pre></div><h5 id="_2-add-retrieved-serialized-id-to-the-configuration-file"><a href="#_2-add-retrieved-serialized-id-to-the-configuration-file" class="header-anchor">#</a> 2. Add retrieved Serialized ID to the configuration file</h5> <p>Using your favorite text editor, open the server.conf file, and add the following lines, while taking care to insert your own <code>Serialized id</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pkcs11-providers /usr/lib64/pkcs11/opensc-pkcs11.so
pkcs11-id <span class="token string">'pkcs11:model=pkcs11:model=PKCS%NNNN%20emulated;token=User%20PIN%20%28OpenPGP%20card%29;manufacturer=ZeitControl;serial=000NNNNNN;id=%03'</span>
</code></pre></div><p>For additional <a href="https://openvpn.net/community-resources/how-to/" target="_blank" rel="noopener noreferrer">settings related to OpenVPN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> authentication, you may also add few lines to handle key maganagement, although it is optional.</p> <details class="custom-block details"><summary>Click to view the code</summary> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># nitrokey config</span>
	
pkcs11-providers /usr/lib64/pkcs11/opensc-pkcs11.so
pkcs11-id <span class="token string">'pkcs11:model=pkcs11:model=PKCS%NNNN%20emulated;token=User%20PIN%20%28OpenPGP%20card%29;manufacturer=ZeitControl;serial=000NNNNNN;id=%03'</span>
<span class="token comment"># pkcs11-pin-cache 300</span>
<span class="token comment"># daemon</span>
<span class="token comment"># auth-retry nointeract</span>
<span class="token comment"># management-hold</span>
<span class="token comment"># management-signal</span>
<span class="token comment"># management 127.0.0.1 8888</span>
<span class="token comment"># management-query-passwords</span>
pkcs11-cert-private <span class="token number">1</span> <span class="token comment"># Prompt for PIN</span>
</code></pre></div></details> <h6 id="optional-step"><a href="#optional-step" class="header-anchor">#</a> Optional step</h6> <p>If you need to test the configuration, with and without the token on the Nitrokey, you may add lines to the same <code>client.conf</code> and comment/uncomment the relevant lines according to your needs:</p> <details class="custom-block details"><summary>Click to view the code</summary> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># non_nitrokey login</span>

<span class="token comment"># cert client.crt</span>
<span class="token comment"># key client.key</span>
<span class="token comment"># tls-auth ta.key 1</span>
</code></pre></div></details> <h5 id="_3-configure-the-openvpn-client"><a href="#_3-configure-the-openvpn-client" class="header-anchor">#</a> 3. Configure the OpenVPN client</h5> <p>The final configuration file <code>client.conf</code> should look like this one:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>client
dev tun
proto udp
remote <span class="token operator">&lt;</span>server<span class="token operator">&gt;</span> <span class="token number">1194</span>
resolv-retry infinite
nobind
user nobody
group nobody
persist-key
persist-tun
ca ca.crt
remote-cert-tls server
cipher AES-256-CBC
verb <span class="token number">3</span>
redirect-gateway def1
tls-version-min <span class="token number">1.2</span> <span class="token comment"># Lower boundary for TLS version </span>
tls-version-max <span class="token number">1.2</span> <span class="token comment"># Higher boundary for TLS version</span>
	
<span class="token comment"># nitrokey login</span>
	
pkcs11-providers /usr/lib64/pkcs11/opensc-pkcs11.so
pkcs11-id <span class="token string">'pkcs11:model=pkcs11:model=PKCS%NNNN%20emulated;token=User%20PIN%20%28OpenPGP%20card%29;manufacturer=ZeitControl;serial=000NNNNNN;id=%03'</span>
<span class="token comment"># pkcs11-pin-cache 300</span>
<span class="token comment"># daemon</span>
<span class="token comment"># auth-retry nointeract</span>
<span class="token comment"># management-hold</span>
<span class="token comment"># management-signal</span>
<span class="token comment"># management 127.0.0.1 8888</span>
<span class="token comment"># management-query-passwords</span>
pkcs11-cert-private <span class="token number">1</span> <span class="token comment"># Prompt for PIN</span>
	
<span class="token comment"># OR</span>
	
<span class="token comment"># non_nitrokey login</span>
	
<span class="token comment"># cert client.crt</span>
<span class="token comment"># key client.key</span>
<span class="token comment"># tls-auth ta.key 1</span>
</code></pre></div><h5 id="_4-known-issues"><a href="#_4-known-issues" class="header-anchor">#</a> 4. Known issues</h5> <p>There are some known issues related to OpenVPN login with OpenSC. Please consult these issues <a href="https://github.com/Nitrokey/wiki/wiki/3rd-Party-Issues" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h4 id="_8-start-the-openvpn-client"><a href="#_8-start-the-openvpn-client" class="header-anchor">#</a> 8. Start the OpenVPN client</h4> <h5 id="_1-start-the-openvpn-service-on-the-client"><a href="#_1-start-the-openvpn-service-on-the-client" class="header-anchor">#</a> 1 Start the OpenVPN service on the client</h5> <p>Enable the OpenVPN service, and start it using these commands:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl -f <span class="token builtin class-name">enable</span> openvpn-server@server.service
$ <span class="token function">sudo</span> systemctl start openvpn-server@server.service
</code></pre></div><p>To double check if the OpenVPN service is active use this command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl status openvpn-server@server.service
</code></pre></div><h5 id="_2-enter-your-user-pin"><a href="#_2-enter-your-user-pin" class="header-anchor">#</a> 2 Enter your User PIN</h5> <p>When executing OpenVPN client, Nitrokey's PIN needs to be entered:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> openvpn --client --config client.conf 
Fri Sep <span class="token number">11</span> <span class="token number">17</span>:42:01 <span class="token number">2020</span> OpenVPN <span class="token number">2.4</span>.9 x86_64-redhat-linux-gnu <span class="token punctuation">[</span>SSL <span class="token punctuation">(</span>OpenSSL<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>LZO<span class="token punctuation">]</span> <span class="token punctuation">[</span>LZ4<span class="token punctuation">]</span> <span class="token punctuation">[</span>EPOLL<span class="token punctuation">]</span> <span class="token punctuation">[</span>PKCS11<span class="token punctuation">]</span> <span class="token punctuation">[</span>MH/PKTINFO<span class="token punctuation">]</span> <span class="token punctuation">[</span>AEAD<span class="token punctuation">]</span> built on Apr <span class="token number">24</span> <span class="token number">2020</span>
Fri Sep <span class="token number">11</span> <span class="token number">17</span>:42:01 <span class="token number">2020</span> library versions: OpenSSL <span class="token number">1.1</span>.1g FIPS  <span class="token number">21</span> Apr <span class="token number">2020</span>, LZO <span class="token number">2.08</span>
Fri Sep <span class="token number">11</span> <span class="token number">17</span>:42:01 <span class="token number">2020</span> PKCS<span class="token comment">#11: Adding PKCS#11 provider '/usr/lib64/pkcs11/opensc-pkcs11.so'</span>
Enter User PIN <span class="token punctuation">(</span>OpenPGP card<span class="token punctuation">)</span> token Password: ******
</code></pre></div><p>Unfortunately OpenVPN doesn't seem to be able to establish a handshake and stops at an error as reported <a href="https://support.nitrokey.com/t/nitrokey-pro-with-openssl-1-1-1-tls-1-3-and-rsa-based-certificates/2180/2" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://support.nitrokey.com/t/openvpn-openssl-error-141f0006/2637" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://community.openvpn.net/openvpn/ticket/1215?__cf_chl_jschl_tk__=92b2a9776b54ce71b2f15e4d3f62dbdb5ee68f5f-1599568561-0-AY906nmSrFwe8EfT2PKawtrgl2NF72nwMrG9mp57SgIAqFmzxHiqod7ED0oVbimJlDD2xzLNLbQU6iUlVImbo8Q25qpDJVJ56YHbE4JKQSusHiwS8GLMm8Di9Gk6k63_qN5SDot-ABpgFoNcaRUHGZQ0fVYKYXZDf5E_0ZAOjPWsD2FXLfc7atx53t9scbdGF1p7xl2VRFcBoy2l7KgvvZU589YNs1wsRG62neISVpM-9E-s9CuccSAX8y3ZQfZUq7et9QIdgaSK9g-PhFqKWJhZLFkmTwR0wmYbKXjhxQ6j" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="custom-block warning"><p class="custom-block-title">error output</p> <p><code>$ sudo openvpn --client --config client.conf</code> <code>Fri Sep 11 17:42:01 2020 OpenVPN 2.4.9 x86_64-redhat-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 24 2020</code> <code>Fri Sep 11 17:42:01 2020 library versions: OpenSSL 1.1.1g FIPS 21 Apr 2020, LZO 2.08</code> <code>Fri Sep 11 17:42:01 2020 PKCS#11: Adding PKCS#11 provider '/usr/lib64/pkcs11/opensc-pkcs11.so'</code> <code>Enter User PIN (OpenPGP card) token Password: ******</code> <code>Fri Sep 11 17:42:12 2020 TCP/UDP: Preserving recently used remote address: [AF_INET]18.157.180.240:1194</code> <code>Fri Sep 11 17:42:12 2020 Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]</code> <code>Fri Sep 11 17:42:12 2020 UDP link local: (not bound)</code> <code>Fri Sep 11 17:42:12 2020 UDP link remote: [AF_INET]18.157.180.240:1194</code> <code>Fri Sep 11 17:42:12 2020 NOTE: UID/GID downgrade will be delayed because of --client, --pull, or --up-delay</code> <code>Fri Sep 11 17:42:12 2020 TLS: Initial packet from [AF_INET]18.157.180.240:1194, sid=d79690cf 9e38ce89</code> <code>Fri Sep 11 17:42:12 2020 VERIFY OK: depth=1, CN=server_CA</code> <code>Fri Sep 11 17:42:12 2020 VERIFY KU OK</code> <code>Fri Sep 11 17:42:12 2020 Validating certificate extended key usage</code> <code>Fri Sep 11 17:42:12 2020 ++ Certificate has EKU (str) TLS Web Server Authentication, expects TLS Web Server Authentication</code> <code>Fri Sep 11 17:42:12 2020 VERIFY EKU OK</code> <code>Fri Sep 11 17:42:12 2020 VERIFY OK: depth=0, CN=server</code> <code>Fri Sep 11 17:42:12 2020 OpenSSL: error:141F0006:SSL routines:tls_construct_cert_verify:EVP lib</code> <code>Fri Sep 11 17:42:12 2020 TLS_ERROR: BIO read tls_read_plaintext error</code> <code>Fri Sep 11 17:42:12 2020 TLS Error: TLS object -&gt; incoming plaintext read error</code> <code>Fri Sep 11 17:42:12 2020 TLS Error: TLS handshake failed</code> <code>Fri Sep 11 17:42:12 2020 SIGUSR1[soft,tls-error] received, process restarting</code> <code>Fri Sep 11 17:42:12 2020 Restart pause, 5 second(s)</code></p></div> <p>In some reported cases it does not prompt for a PIN on the terminal. One workaround would be to use to use this command to login with the PIN:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ telnet <span class="token number">8888</span> password <span class="token string">'User PIN (OpenPGP card) token'</span> <span class="token operator">&lt;</span>PIN<span class="token operator">&gt;</span>
</code></pre></div><p>Alternatively, you could <a href="https://forums.openvpn.net/viewtopic.php?t=23318" target="_blank" rel="noopener noreferrer">recompile OpenVPN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> client with systemd support disabled, and it will prompt you for the PIN as expected.</p> <p>Another option, would be to login to your OpenVPN instance with the Viscosity client which provides a better user experience especially for entering the PIN.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Nitrokey/nitrokey-documentation/edit/master/pro/linux/openvpn-configuration-with-easyrsa.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/2/2020, 11:20:21 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pro/linux/two-factor-authentication-for-erp-software-odoo.html" class="prev">
        Two-factor Authentication for ERP Software Odoo
      </a></span> <span class="next"><a href="/pro/linux/hard-disk-encryption.html">
        Hard Disk Encryption
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.123296ed.js" defer></script><script src="/assets/js/39.1c9eb1ed.js" defer></script><script src="/assets/js/37.64470159.js" defer></script>
  </body>
</html>
